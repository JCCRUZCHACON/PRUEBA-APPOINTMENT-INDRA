openapi: 3.0.3
info:
  title: API de Agendamiento de Citas Médicas
  description: |
    API backend para agendar citas médicas para asegurados en Perú y Chile.  
    Refleja el modelado de DynamoDB/RDS y el cambio de estado de las citas sin alterar la fecha/hora.
  version: 1.0.0
servers:
  - url: https://lgnm6ddlik.execute-api.us-east-1.amazonaws.com/dev
    description: Servidor AWS API Gateway (stage dev)

tags:
  - name: Citas
    description: Endpoints para crear y listar citas médicas
  - name: Agendamiento
    description: Procesos de confirmación y manejo de estado de citas

paths:
  /appointments:
    post:
      tags:
        - Citas
      summary: Crear una nueva cita
      description: Recibe los datos de una cita y la registra en DynamoDB, enviándola a SNS y SQS de confirmación.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AppointmentRequest'
      responses:
        '200':
          description: Cita creada correctamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppointmentResponse'
        '400':
          description: Datos incompletos o inválidos
          content:
            application/json:
              example:
                message: "Datos incompletos"
        '500':
          description: Error interno del servidor
          content:
            application/json:
              example:
                message: "Error interno del servidor"
                error: "Descripción del error"

  /appointments/{insuredId}:
    get:
      tags:
        - Citas
      summary: Listar citas por asegurado
      description: Devuelve todas las citas registradas de un asegurado, incluyendo su estado.
      parameters:
        - name: insuredId
          in: path
          required: true
          schema:
            type: string
          description: Código del asegurado (5 dígitos)
          example: "00001"
      responses:
        '200':
          description: Lista de citas del asegurado
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AppointmentResponse'
                example:
                  - insuredId: "00001"
                    countryISO: "PE"
                    schedule:
                      scheduleId: 100
                      centerId: 2
                      specialtyId: 6
                      medicId: 4
                      date: "2025-11-09T09:30:00Z"
                    status: "pending"
                    createdAt: "2025-11-09T16:02:32.990Z"
                  - insuredId: "00001"
                    countryISO: "PE"
                    schedule:
                      scheduleId: 100
                      centerId: 2
                      specialtyId: 6
                      medicId: 4
                      date: "2025-11-09T09:30:00Z"
                    status: "completed"
                    createdAt: "2025-11-09T16:02:32.990Z"
        '400':
          description: insuredId es requerido
          content:
            application/json:
              example:
                message: "insuredId es requerido"
        '404':
          description: Asegurado no encontrado
          content:
            application/json:
              example:
                message: "No se encontraron citas para el asegurado 00001"
        '500':
          description: Error interno del servidor
          content:
            application/json:
              example:
                message: "Error interno del servidor"
                error: "Descripción del error"

components:
  schemas:
    Schedule:
      type: object
      properties:
        centerId:
          type: integer
          description: ID del centro médico
          example: 2
        specialtyId:
          type: integer
          description: ID de la especialidad
          example: 6
        medicId:
          type: integer
          description: ID del médico
          example: 4
        date:
          type: string
          format: date-time
          description: Fecha y hora de la cita (no cambia al actualizar status)
          example: "2025-11-09T09:30:00Z"
      required:
        - centerId
        - specialtyId
        - medicId
        - date

    AppointmentRequest:
      type: object
      properties:
        insuredId:
          type: string
          description: Código del asegurado (5 dígitos)
          example: "00001"
        countryISO:
          type: string
          description: País del asegurado (PE o CL)
          example: "PE"
        schedule:
          $ref: '#/components/schemas/Schedule'
      required:
        - insuredId
        - countryISO
        - schedule

    AppointmentResponse:
      allOf:
        - $ref: '#/components/schemas/AppointmentRequest'
        - type: object
          properties:
            status:
              type: string
              description: Estado del agendamiento (pending/completed)
              example: "completed"
            createdAt:
              type: string
              format: date-time
              description: Fecha de creación de la cita (no cambia al actualizar status)
              example: "2025-11-09T16:02:32.990Z"
